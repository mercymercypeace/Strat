local Players = game:GetService("Players")
local player = Players.LocalPlayer

local instances = nil

if _G.getrenv then
    pcall(function() return _G.getrenv() end)
end

if _G.getinstances then
    local success, result = pcall(function() return _G.getinstances() end)
    if success then instances = result end
end

local library = {flags = {}, windows = {}, open = true, cursor = nil}

local tweenService = game:GetService"TweenService"
local inputService = game:GetService"UserInputService"

local dragging, dragInput, dragStart, startPos, dragObject

local function update(input)
    local delta = input.Position - dragStart
    local yPos = (startPos.Y.Offset + delta.Y) < -36 and -36 or startPos.Y.Offset + delta.Y
    dragObject:TweenPosition(UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, yPos), "Out", "Quint", 0.1, true)
end


function library:Create(class, properties)
    properties = typeof(properties) == "table" and properties or {}
    local inst = Instance.new(class)
    for property, value in next, properties do
        inst[property] = value
    end
    return inst
end

function library:Draw(class, properties)
    if not _G.Drawing then return nil end
    local props = type(properties) == 'table' and properties or {};
    local object = _G.Drawing.new(class)
    for p, v in next, props do 
        object[p] = v; 
    end
    return object
end

local function createOptionHolder(holderTitle, parent, parentTable, subHolder)
    local size = subHolder and 34 or 40
    parentTable.main = library:Create("ImageButton", {
        LayoutOrder = subHolder and parentTable.position or 0,
        Position = UDim2.new(0, 20 + (250 * (parentTable.position or 0)), 0, 20),
        Size = UDim2.new(0, 230, 0, size),
        BackgroundTransparency = 1,
        Image = "rbxassetid://3570695787",
        ImageColor3 = Color3.fromRGB(20, 20, 20),
        ScaleType = Enum.ScaleType.Slice,
        SliceCenter = Rect.new(100, 100, 100, 100),
        SliceScale = 0.04,
        ClipsDescendants = true,
        Parent = parent
    })
    
    local round
    if not subHolder then
        round = library:Create("ImageLabel", {
            Size = UDim2.new(1, 0, 0, size),
            BackgroundTransparency = 1,
            Image = "rbxassetid://3570695787",
            ImageColor3 = parentTable.open and (subHolder and Color3.fromRGB(16, 16, 16) or Color3.fromRGB(10, 10, 10)) or (subHolder and Color3.fromRGB(10, 10, 10) or Color3.fromRGB(6, 6, 6)),
            ScaleType = Enum.ScaleType.Slice,
            SliceCenter = Rect.new(100, 100, 100, 100),
            SliceScale = 0.04,
            Parent = parentTable.main
        })
    end
    
    local title = library:Create("TextLabel", {
        Size = UDim2.new(1, 0, 0, size),
        BackgroundTransparency = subHolder and 0 or 1,
        BackgroundColor3 = Color3.fromRGB(10, 10, 10),
        BorderSizePixel = 0,
        Text = holderTitle,
        TextSize = subHolder and 16 or 17,
        Font = Enum.Font.GothamBold,
        TextColor3 = Color3.fromRGB(255, 255, 255),
        Parent = parentTable.main
    })
    
    local closeHolder = library:Create("Frame", {
        Position = UDim2.new(1, 0, 0, 0),
        Size = UDim2.new(-1, 0, 1, 0),
        SizeConstraint = Enum.SizeConstraint.RelativeYY,
        BackgroundTransparency = 1,
        Parent = title
    })
    
    local close = library:Create("ImageLabel", {
        AnchorPoint = Vector2.new(0.5, 0.5),
        Position = UDim2.new(0.5, 0, 0.5, 0),
        Size = UDim2.new(1, -size - 10, 1, -size - 10),
        Rotation = parentTable.open and 90 or 180,
        BackgroundTransparency = 1,
        Image = "rbxassetid://4918373417",
        ImageColor3 = parentTable.open and Color3.fromRGB(50, 50, 50) or Color3.fromRGB(30, 30, 30),
        ScaleType = Enum.ScaleType.Fit,
        Parent = closeHolder
    })
    
    parentTable.content = library:Create("Frame", {
        Position = UDim2.new(0, 0, 0, size),
        Size = UDim2.new(1, 0, 1, -size),
        BackgroundTransparency = 1,
        Parent = parentTable.main
    })
    
    local layout = library:Create("UIListLayout", {
        SortOrder = Enum.SortOrder.LayoutOrder,
        Parent = parentTable.content
    })
    
    layout.Changed:connect(function()
        parentTable.content.Size = UDim2.new(1, 0, 0, layout.AbsoluteContentSize.Y)
        parentTable.main.Size = #parentTable.options > 0 and parentTable.open and UDim2.new(0, 230, 0, layout.AbsoluteContentSize.Y + size) or UDim2.new(0, 230, 0, size)
    end)
    
    if not subHolder then
        library:Create("UIPadding", {
            Parent = parentTable.content
        })
        
        title.InputBegan:connect(function(input)
            if input.UserInputType == Enum.UserInputType.MouseButton1 then
                dragObject = parentTable.main
                dragging = true
                dragStart = input.Position
                startPos = dragObject.Position
            end
        end)
        title.InputChanged:connect(function(input)
            if dragging and input.UserInputType == Enum.UserInputType.MouseMovement then
                dragInput = input
            end
        end)
        title.InputEnded:connect(function(input)
            if input.UserInputType == Enum.UserInputType.MouseButton1 then
                dragging = false
            end
        end)
    end
    
    closeHolder.InputBegan:connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            parentTable.open = not parentTable.open
            tweenService:Create(close, TweenInfo.new(0.2, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {Rotation = parentTable.open and 90 or 180, ImageColor3 = parentTable.open and Color3.fromRGB(50, 50, 50) or Color3.fromRGB(30, 30, 30)}):Play()
            if subHolder then
                tweenService:Create(title, TweenInfo.new(0.2, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {BackgroundColor3 = parentTable.open and Color3.fromRGB(16, 16, 16) or Color3.fromRGB(10, 10, 10)}):Play()
            else
                tweenService:Create(round, TweenInfo.new(0.2, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {ImageColor3 = parentTable.open and Color3.fromRGB(10, 10, 10) or Color3.fromRGB(6, 6, 6)}):Play()
            end
            parentTable.main:TweenSize(#parentTable.options > 0 and parentTable.open and UDim2.new(0, 230, 0, layout.AbsoluteContentSize.Y + size) or UDim2.new(0, 230, 0, size), "Out", "Quad", 0.2, true)
        end
    end)
    
    function parentTable:SetTitle(newTitle)
        title.Text = tostring(newTitle)
    end
    
    return parentTable
end

local function createLabel(option, parent)
    local main = library:Create("TextLabel", {
        LayoutOrder = option.position,
        Size = UDim2.new(1, 0, 0, 26),
        BackgroundTransparency = 1,
        Text = " " .. option.text,
        TextSize = 17,
        Font = Enum.Font.Gotham,
        TextColor3 = Color3.fromRGB(255, 255, 255),
        TextXAlignment = Enum.TextXAlignment.Left,
        Parent = parent.content
    })
    
    setmetatable(option, {__newindex = function(t, i, v)
        if i == "Text" then
            main.Text = " " .. tostring(v)
        end
    end})
end

local function loadOptions(option, holder)
    for _,newOption in next, option.options do
        if newOption.type == "label" then
            createLabel(newOption, option)
        end
    end
end

local function getFnctions(parent)
    function parent:AddLabel(option)
        option = typeof(option) == "table" and option or {}
        option.text = tostring(option.text)
        option.type = "label"
        option.position = #self.options
        table.insert(self.options, option)
        return option
    end
end

function library:CreateWindow(title)
    local window = {title = tostring(title), options = {}, open = true, canInit = true, init = false, position = #self.windows}
    getFnctions(window)
    table.insert(library.windows, window)
    return window
end

function library:Init()
    self.base = self.base or self:Create("ScreenGui")
    if _G.syn and _G.syn.protect_gui then
        _G.syn.protect_gui(self.base)
        self.base.Parent = game:GetService"CoreGui"
    elseif type(_G.get_hidden_gui) == 'function' then
        self.base.Parent = _G.get_hidden_gui()
    elseif type(_G.gethui) == 'function' then
        self.base.Parent = _G.gethui()
    else
        self.base.Name = tostring(math.random())
        self.base.Parent = game:GetService"CoreGui"
    end
    
    if not self.cursor then
        self.cursor = self:Create("Frame", {
            ZIndex = 100,
            AnchorPoint = Vector2.new(0, 0),
            Size = UDim2.new(0, 5, 0, 5),
            BackgroundColor3 = Color3.fromRGB(255, 255, 255),
            Parent = self.base
        })
    end
    
    for _, window in next, self.windows do
        if window.canInit and not window.init then
            window.init = true
            createOptionHolder(window.title, self.base, window)
            loadOptions(window)
        end
    end
end

function library:Close()
    self.open = not self.open
    if self.cursor then
        self.cursor.Visible = self.open
    end
    if self.activePopup then
        self.activePopup:Close()
    end
    for _, window in next, self.windows do
        if window.main then
            window.main.Visible = self.open
        end
    end
end

inputService.InputChanged:connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseMovement then
        if library.cursor then
            local mouse = inputService:GetMouseLocation() + Vector2.new(0, -36)
            library.cursor.Position = UDim2.new(0, mouse.X - 2, 0, mouse.Y - 2)
        end
    end
    if input == dragInput and dragging then
        update(input)
    end
end)

local statObjects = {}

local function findStatObject(statName)
    if statObjects[statName] then
        return statObjects[statName]
    end
    
    local variations = {statName, statName:lower(), statName:upper(), statName:sub(1,1):upper()..statName:sub(2):lower()}
    
    for _, name in pairs(variations) do
        local found = player:FindFirstChild(name)
        if found and (found:IsA("IntValue") or found:IsA("NumberValue") or found:IsA("StringValue")) then
            statObjects[statName] = found
            return found
        end
    end
    
    if instances then
        for _, instance in pairs(instances) do
            if instance.Parent == player then
                local instanceName = instance.Name:lower()
                for _, name in pairs(variations) do
                    if instanceName == name:lower() and (instance:IsA("IntValue") or instance:IsA("NumberValue") or instance:IsA("StringValue")) then
                        statObjects[statName] = instance
                        return instance
                    end
                end
            end
        end
    end
    
    return nil
end

local function getPlayerStats()
    local stats = {
        Coins = 0,
        Gems = 0,
        Triumphs = 0,
        Loses = 0,
        Level = 0
    }
    
    local coins = findStatObject("Coins") or findStatObject("coins")
    local gems = findStatObject("Gems")
    local triumphs = findStatObject("Triumphs") or findStatObject("triumps")
    local loses = findStatObject("Loses") or findStatObject("loses")
    local level = findStatObject("Level")
    
    if coins then stats.Coins = coins.Value end
    if gems then stats.Gems = gems.Value end
    if triumphs then stats.Triumphs = triumphs.Value end
    if loses then stats.Loses = loses.Value end
    if level then stats.Level = level.Value end
    
    return stats
end

local window = library:CreateWindow(player.Name .. "'s Stats")

local coinsLabel = window:AddLabel({text = "Coins: 0"})
local gemsLabel = window:AddLabel({text = "Gems: 0"})
local triumphsLabel = window:AddLabel({text = "Triumphs: 0"})
local losesLabel = window:AddLabel({text = "Loses: 0"})
local levelLabel = window:AddLabel({text = "Level: 0"})

local function updateStats()
    local newStats = getPlayerStats()
    coinsLabel.Text = "Coins: " .. tostring(newStats.Coins)
    gemsLabel.Text = "Gems: " .. tostring(newStats.Gems)
    triumphsLabel.Text = "Triumphs: " .. tostring(newStats.Triumphs)
    losesLabel.Text = "Loses: " .. tostring(newStats.Loses)
    levelLabel.Text = "Level: " .. tostring(newStats.Level)
end

local function setupStatMonitoring(statObj)
    if not statObj then return end
    
    if _G.getconnections then
        local success, connections = pcall(function() return _G.getconnections(statObj.Changed) end)
        if success and connections and #connections > 0 then
            for _, connection in pairs(connections) do
                if connection.State then
                    connection:Enable()
                end
            end
        end
    end
    
    statObj.Changed:Connect(function()
        updateStats()
    end)
end

local function refreshStatObjects()
    statObjects = {}
    findStatObject("Coins")
    findStatObject("Gems")
    findStatObject("Triumphs")
    findStatObject("Loses")
    findStatObject("Level")
    
    for statName, statObj in pairs(statObjects) do
        if statObj and statObj.Parent == player then
            setupStatMonitoring(statObj)
        end
    end
end

for _, stat in pairs(player:GetChildren()) do
    local statName = stat.Name:lower()
    if (statName == "coins" or statName == "gems" or statName == "triumphs" or statName == "triumps" or 
        statName == "loses" or statName == "level") and 
        (stat:IsA("IntValue") or stat:IsA("NumberValue") or stat:IsA("StringValue")) then
        setupStatMonitoring(stat)
    end
end

player.ChildAdded:Connect(function(child)
    local statName = child.Name:lower()
    if (statName == "coins" or statName == "gems" or statName == "triumphs" or statName == "triumps" or 
        statName == "loses" or statName == "level") and 
        (child:IsA("IntValue") or child:IsA("NumberValue") or child:IsA("StringValue")) then
        setupStatMonitoring(child)
        refreshStatObjects()
    end
end)

refreshStatObjects()

spawn(function()
    while wait(1) do
        updateStats()
    end
end)

spawn(function()
    while wait(5) do
        refreshStatObjects()
    end
end)

library:Init()

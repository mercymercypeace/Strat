local Players = game:GetService("Players")
local UserInputService = game:GetService("UserInputService")
local TweenService = game:GetService("TweenService")
local player = Players.LocalPlayer

local isMobile = UserInputService.TouchEnabled and not UserInputService.KeyboardEnabled

local instances = nil

if _G.getrenv then
    pcall(function() return _G.getrenv() end)
end

if _G.getinstances then
    local success, result = pcall(function() return _G.getinstances() end)
    if success then instances = result end
end

local library
local success, result = pcall(function()
    local url = 'https://raw.githubusercontent.com/bloodball/-back-ups-for-libs/main/wall%20v3'
    local content
    
    if type(game.HttpGet) == "function" then
        content = game:HttpGet(url)
    elseif _G.request and type(_G.request) == "function" then
        local response = _G.request({Url = url, Method = "GET"})
        content = response.Body
    elseif _G.syn and _G.syn.request and type(_G.syn.request) == "function" then
        local response = _G.syn.request({Url = url, Method = "GET"})
        content = response.Body
    else
        error("No HTTP method available")
    end
    
    if content then
        local loaded = loadstring(content)
        if loaded then
            return loaded()
        else
            error("Failed to loadstring")
        end
    else
        error("No content received")
    end
end)
if success and result then
    library = result
else
    error("Failed to load UI library: " .. tostring(result))
end

local w = library:CreateWindow(player.Name .. "'s Stats")

if isMobile then
    spawn(function()
        wait(0.5)
        local windowMain = nil
        
        for _, obj in pairs(game:GetService("CoreGui"):GetDescendants()) do
            if obj:IsA("ImageButton") and obj.Name == "Main" then
                windowMain = obj
                break
            elseif (obj:IsA("Frame") or obj:IsA("ImageButton")) then
                local title = obj:FindFirstChild("Title") or (obj.Parent and obj.Parent:FindFirstChild("Title"))
                if title and string.find(title.Text or "", player.Name) then
                    windowMain = obj
                    break
                end
            end
        end
        
        if windowMain then
            windowMain.Active = true
            windowMain.Draggable = true
            
            local dragging = false
            local dragInput = nil
            local dragStart = nil
            local startPos = nil
            
            local function updateDrag(input)
                if dragging and dragStart and startPos then
                    local delta = input.Position - dragStart
                    local newPos = UDim2.new(
                        startPos.X.Scale,
                        startPos.X.Offset + delta.X,
                        startPos.Y.Scale,
                        math.max(-36, startPos.Y.Offset + delta.Y)
                    )
                    windowMain.Position = newPos
                end
            end
            
            windowMain.InputBegan:Connect(function(input)
                if input.UserInputType == Enum.UserInputType.Touch or input.UserInputType == Enum.UserInputType.MouseButton1 then
                    dragging = true
                    dragStart = input.Position
                    startPos = windowMain.Position
                    dragInput = input
                end
            end)
            
            UserInputService.InputChanged:Connect(function(input)
                if input == dragInput and dragging then
                    updateDrag(input)
                end
            end)
            
            UserInputService.InputEnded:Connect(function(input)
                if input.UserInputType == Enum.UserInputType.Touch or input.UserInputType == Enum.UserInputType.MouseButton1 then
                    dragging = false
                end
            end)
            
            local titleBar = windowMain:FindFirstChild("Title") or windowMain:FindFirstChildOfClass("TextLabel")
            if titleBar then
                local closeButton = Instance.new("TextButton")
                closeButton.Name = "MobileCloseButton"
                closeButton.Size = UDim2.new(0, 40, 0, 40)
                closeButton.Position = UDim2.new(1, -45, 0, 5)
                closeButton.BackgroundColor3 = Color3.fromRGB(200, 50, 50)
                closeButton.BorderSizePixel = 0
                closeButton.Text = "X"
                closeButton.TextColor3 = Color3.fromRGB(255, 255, 255)
                closeButton.TextSize = 20
                closeButton.Font = Enum.Font.GothamBold
                closeButton.ZIndex = 10
                closeButton.Parent = titleBar.Parent or windowMain
                
                local closeCorner = Instance.new("UICorner")
                closeCorner.CornerRadius = UDim.new(0, 6)
                closeCorner.Parent = closeButton
                
                closeButton.MouseButton1Click:Connect(function()
                    windowMain.Visible = false
                end)
                
                closeButton.TouchTap:Connect(function()
                    windowMain.Visible = false
                end)
                
                closeButton.MouseEnter:Connect(function()
                    TweenService:Create(closeButton, TweenInfo.new(0.2), {
                        BackgroundColor3 = Color3.fromRGB(255, 70, 70)
                    }):Play()
                end)
                
                closeButton.MouseLeave:Connect(function()
                    TweenService:Create(closeButton, TweenInfo.new(0.2), {
                        BackgroundColor3 = Color3.fromRGB(200, 50, 50)
                    }):Play()
                end)
            end
        end
    end)
end

local b = w:CreateFolder("Stats")

if isMobile then
    b:Button("Close GUI", function()
        spawn(function()
            wait(0.1)
            for _, obj in pairs(game:GetService("CoreGui"):GetDescendants()) do
                if obj:IsA("ImageButton") and obj.Name == "Main" then
                    obj.Visible = false
                elseif (obj:IsA("Frame") or obj:IsA("ImageButton")) and obj:FindFirstChild("Title") then
                    obj.Visible = false
                end
            end
        end)
    end)
end

local coinsLabel = b:Label("Coins: 0", {
    TextSize = 18,
    TextColor = Color3.fromRGB(255, 255, 255),
    BgColor = Color3.fromRGB(50, 50, 50),
})

local gemsLabel = b:Label("Gems: 0", {
    TextSize = 18,
    TextColor = Color3.fromRGB(255, 255, 255),
    BgColor = Color3.fromRGB(50, 50, 50),
})

local triumphsLabel = b:Label("Triumphs: 0", {
    TextSize = 18,
    TextColor = Color3.fromRGB(255, 255, 255),
    BgColor = Color3.fromRGB(50, 50, 50),
})

local losesLabel = b:Label("Loses: 0", {
    TextSize = 18,
    TextColor = Color3.fromRGB(255, 255, 255),
    BgColor = Color3.fromRGB(50, 50, 50),
})

local levelLabel = b:Label("Level: 0", {
    TextSize = 18,
    TextColor = Color3.fromRGB(255, 255, 255),
    BgColor = Color3.fromRGB(50, 50, 50),
})

local statObjects = {}

local function findStatObject(statName)
    if statObjects[statName] then
        return statObjects[statName]
    end
    
    local variations = {statName, statName:lower(), statName:upper(), statName:sub(1,1):upper()..statName:sub(2):lower()}
    
    for _, name in pairs(variations) do
        local found = player:FindFirstChild(name)
        if found and (found:IsA("IntValue") or found:IsA("NumberValue") or found:IsA("StringValue")) then
            statObjects[statName] = found
            return found
        end
    end
    
    if instances then
        for _, instance in pairs(instances) do
            if instance.Parent == player then
                local instanceName = instance.Name:lower()
                for _, name in pairs(variations) do
                    if instanceName == name:lower() and (instance:IsA("IntValue") or instance:IsA("NumberValue") or instance:IsA("StringValue")) then
                        statObjects[statName] = instance
                        return instance
                    end
                end
            end
        end
    end
    
    return nil
end

local function getPlayerStats()
    local stats = {
        Coins = 0,
        Gems = 0,
        Triumphs = 0,
        Loses = 0,
        Level = 0
    }
    
    local coins = findStatObject("Coins") or findStatObject("coins")
    local gems = findStatObject("Gems")
    local triumphs = findStatObject("Triumphs") or findStatObject("triumps")
    local loses = findStatObject("Loses") or findStatObject("loses")
    local level = findStatObject("Level")
    
    if coins then stats.Coins = coins.Value end
    if gems then stats.Gems = gems.Value end
    if triumphs then stats.Triumphs = triumphs.Value end
    if loses then stats.Loses = loses.Value end
    if level then stats.Level = level.Value end
    
    return stats
end

local function updateStats()
    local newStats = getPlayerStats()
    coinsLabel:Refresh("Coins: " .. tostring(newStats.Coins))
    gemsLabel:Refresh("Gems: " .. tostring(newStats.Gems))
    triumphsLabel:Refresh("Triumphs: " .. tostring(newStats.Triumphs))
    losesLabel:Refresh("Loses: " .. tostring(newStats.Loses))
    levelLabel:Refresh("Level: " .. tostring(newStats.Level))
end

local function setupStatMonitoring(statObj)
    if not statObj then return end
    
    if _G.getconnections then
        local success, connections = pcall(function() return _G.getconnections(statObj.Changed) end)
        if success and connections and #connections > 0 then
            for _, connection in pairs(connections) do
                if connection.State then
                    connection:Enable()
                end
            end
        end
    end
    
    statObj.Changed:Connect(function()
        updateStats()
    end)
end

local function refreshStatObjects()
    statObjects = {}
    findStatObject("Coins")
    findStatObject("Gems")
    findStatObject("Triumphs")
    findStatObject("Loses")
    findStatObject("Level")
    
    for statName, statObj in pairs(statObjects) do
        if statObj and statObj.Parent == player then
            setupStatMonitoring(statObj)
        end
    end
end

for _, stat in pairs(player:GetChildren()) do
    local statName = stat.Name:lower()
    if (statName == "coins" or statName == "gems" or statName == "triumphs" or statName == "triumps" or 
        statName == "loses" or statName == "level") and 
        (stat:IsA("IntValue") or stat:IsA("NumberValue") or stat:IsA("StringValue")) then
        setupStatMonitoring(stat)
    end
end

player.ChildAdded:Connect(function(child)
    local statName = child.Name:lower()
    if (statName == "coins" or statName == "gems" or statName == "triumphs" or statName == "triumps" or 
        statName == "loses" or statName == "level") and 
        (child:IsA("IntValue") or child:IsA("NumberValue") or child:IsA("StringValue")) then
        setupStatMonitoring(child)
        refreshStatObjects()
    end
end)

refreshStatObjects()

spawn(function()
    while wait(1) do
        updateStats()
    end
end)

spawn(function()
    while wait(5) do
        refreshStatObjects()
    end
end)

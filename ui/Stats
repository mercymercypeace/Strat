local Players = game:GetService("Players")
local TweenService = game:GetService("TweenService")
local UserInputService = game:GetService("UserInputService")
local player = Players.LocalPlayer
local playerGui = player:WaitForChild("PlayerGui")

local instances = nil

if _G.getrenv then
    pcall(function() return _G.getrenv() end)
end

if _G.getinstances then
    local success, result = pcall(function() return _G.getinstances() end)
    if success then instances = result end
end

local isMobile = UserInputService.TouchEnabled and not UserInputService.KeyboardEnabled
local camera = workspace.CurrentCamera
local screenSize = camera and camera.ViewportSize or Vector2.new(1920, 1080)
local scale = isMobile and math.min(screenSize.X / 1920, screenSize.Y / 1080) or 1
local mobileScale = isMobile and 1.5 or 1

local screenGui = Instance.new("ScreenGui")
screenGui.Name = "StatsGUI"
screenGui.ResetOnSpawn = false
screenGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
screenGui.Parent = playerGui

local _frameWidth = 1080
local _frameHeight = 1080
local titleBarHeight = isMobile and math.floor(80 * scale) or 60

local mainFrame = Instance.new("Frame")
mainFrame.Name = "MainFrame"
if isMobile then
    mainFrame.Size = UDim2.new(0.9, 0, 0.9, 0)
    mainFrame.Position = UDim2.new(0.5, 0, 0.5, 0)
    mainFrame.AnchorPoint = Vector2.new(0.5, 0.5)
else
    local maxWidth = math.min(1080, screenSize.X * 0.8)
    local maxHeight = math.min(1080, screenSize.Y * 0.8)
    mainFrame.Size = UDim2.new(0, maxWidth, 0, maxHeight)
    mainFrame.Position = UDim2.new(0.5, 0, 0.5, 0)
    mainFrame.AnchorPoint = Vector2.new(0.5, 0.5)
end
mainFrame.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
mainFrame.BackgroundTransparency = 1
mainFrame.BorderSizePixel = 0
mainFrame.Active = true
mainFrame.Draggable = true
mainFrame.Parent = screenGui

local corner = Instance.new("UICorner")
corner.CornerRadius = UDim.new(0, isMobile and math.floor(12 * scale) or 8)
corner.Parent = mainFrame

local titleBar = Instance.new("Frame")
titleBar.Name = "TitleBar"
titleBar.Size = UDim2.new(1, 0, 0, titleBarHeight)
titleBar.Position = UDim2.new(0, 0, 0, 0)
titleBar.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
titleBar.BorderSizePixel = 0
titleBar.Parent = mainFrame

local titleCorner = Instance.new("UICorner")
titleCorner.CornerRadius = UDim.new(0, isMobile and math.floor(12 * scale) or 8)
titleCorner.Parent = titleBar

local titleText = Instance.new("TextLabel")
titleText.Name = "TitleText"
local titleTextPadding = isMobile and math.floor(100 * scale) or 80
titleText.Size = UDim2.new(1, -titleTextPadding, 1, 0)
titleText.Position = UDim2.new(0, isMobile and math.floor(15 * scale) or 10, 0, 0)
titleText.BackgroundTransparency = 1
titleText.Text = player.Name .. "'s Stats"
titleText.TextColor3 = Color3.fromRGB(255, 255, 255)
titleText.TextSize = isMobile and math.floor(24 * scale) or 20
titleText.Font = Enum.Font.GothamBold
titleText.TextXAlignment = Enum.TextXAlignment.Left
titleText.TextScaled = isMobile
titleText.Parent = titleBar

local buttonSize = isMobile and math.floor(50 * scale) or 35
local buttonPadding = isMobile and math.floor(8 * scale) or 5

local minimizeButton = Instance.new("TextButton")
minimizeButton.Name = "MinimizeButton"
minimizeButton.Size = UDim2.new(0, buttonSize, 0, buttonSize)
local minimizeButtonOffset = isMobile and math.floor(120 * scale) or 70
minimizeButton.Position = UDim2.new(1, -minimizeButtonOffset, 0, buttonPadding)
minimizeButton.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
minimizeButton.BorderSizePixel = 0
minimizeButton.Text = "-"
minimizeButton.TextColor3 = Color3.fromRGB(255, 255, 255)
minimizeButton.TextSize = isMobile and math.floor(28 * scale) or 24
minimizeButton.Font = Enum.Font.GothamBold
minimizeButton.TextScaled = isMobile
minimizeButton.Parent = titleBar

local minimizeCorner = Instance.new("UICorner")
minimizeCorner.CornerRadius = UDim.new(0, isMobile and math.floor(6 * scale) or 4)
minimizeCorner.Parent = minimizeButton

local closeButton = Instance.new("TextButton")
closeButton.Name = "CloseButton"
closeButton.Size = UDim2.new(0, buttonSize, 0, buttonSize)
local closeButtonOffset = isMobile and math.floor(60 * scale) or 35
closeButton.Position = UDim2.new(1, -closeButtonOffset, 0, buttonPadding)
closeButton.BackgroundColor3 = Color3.fromRGB(200, 50, 50)
closeButton.BorderSizePixel = 0
closeButton.Text = "X"
closeButton.TextColor3 = Color3.fromRGB(255, 255, 255)
closeButton.TextSize = isMobile and math.floor(26 * scale) or 20
closeButton.Font = Enum.Font.GothamBold
closeButton.TextScaled = isMobile
closeButton.Parent = titleBar

local closeCorner = Instance.new("UICorner")
closeCorner.CornerRadius = UDim.new(0, isMobile and math.floor(6 * scale) or 4)
closeCorner.Parent = closeButton

local contentPadding = isMobile and math.floor(15 * scale) or 10
local contentFrame = Instance.new("ScrollingFrame")
contentFrame.Name = "ContentFrame"
contentFrame.Size = UDim2.new(1, -contentPadding*2, 1, -titleBarHeight - contentPadding)
contentFrame.Position = UDim2.new(0, contentPadding, 0, titleBarHeight)
contentFrame.BackgroundTransparency = 1
contentFrame.BorderSizePixel = 0
contentFrame.ScrollBarThickness = math.floor(6 * scale * mobileScale)
contentFrame.Parent = mainFrame

local listLayout = Instance.new("UIListLayout")
listLayout.Padding = UDim.new(0, isMobile and math.floor(15 * scale) or 10)
listLayout.SortOrder = Enum.SortOrder.LayoutOrder
listLayout.Parent = contentFrame

local originalSize = mainFrame.Size
local isMinimized = false

local tweenInfo = TweenInfo.new(0.3, Enum.EasingStyle.Linear, Enum.EasingDirection.InOut)

local openTween = TweenService:Create(mainFrame, tweenInfo, {
    BackgroundTransparency = 0
})
openTween:Play()

minimizeButton.MouseButton1Click:Connect(function()
    isMinimized = not isMinimized
    if isMinimized then
        local minimizedSize
        if isMobile then
            minimizedSize = UDim2.new(0.9, 0, 0, titleBarHeight)
        else
            local currentWidth = mainFrame.AbsoluteSize.X
            minimizedSize = UDim2.new(0, currentWidth, 0, titleBarHeight)
        end
        local minimizeTween = TweenService:Create(mainFrame, tweenInfo, {
            Size = minimizedSize
        })
        minimizeTween:Play()
        spawn(function()
            wait(0.15)
            contentFrame.Visible = false
        end)
    else
        contentFrame.Visible = true
        local restoreTween = TweenService:Create(mainFrame, tweenInfo, {
            Size = originalSize
        })
        restoreTween:Play()
    end
end)

closeButton.MouseButton1Click:Connect(function()
    local closeTween = TweenService:Create(mainFrame, tweenInfo, {
        BackgroundTransparency = 1,
        Size = UDim2.new(0, 0, 0, 0)
    })
    closeTween:Play()
    closeTween.Completed:Connect(function()
        screenGui:Destroy()
    end)
end)

minimizeButton.MouseEnter:Connect(function()
    local hoverTween = TweenService:Create(minimizeButton, TweenInfo.new(0.2, Enum.EasingStyle.Linear), {
        BackgroundColor3 = Color3.fromRGB(80, 80, 80)
    })
    hoverTween:Play()
end)

minimizeButton.MouseLeave:Connect(function()
    local hoverTween = TweenService:Create(minimizeButton, TweenInfo.new(0.2, Enum.EasingStyle.Linear), {
        BackgroundColor3 = Color3.fromRGB(60, 60, 60)
    })
    hoverTween:Play()
end)

closeButton.MouseEnter:Connect(function()
    local hoverTween = TweenService:Create(closeButton, TweenInfo.new(0.2, Enum.EasingStyle.Linear), {
        BackgroundColor3 = Color3.fromRGB(255, 70, 70)
    })
    hoverTween:Play()
end)

closeButton.MouseLeave:Connect(function()
    local hoverTween = TweenService:Create(closeButton, TweenInfo.new(0.2, Enum.EasingStyle.Linear), {
        BackgroundColor3 = Color3.fromRGB(200, 50, 50)
    })
    hoverTween:Play()
end)

local function createStatLabel(statName, value)
    local statFrameHeight = isMobile and math.floor(80 * scale) or 60
    local statPadding = isMobile and math.floor(15 * scale) or 10
    local statInnerPadding = isMobile and math.floor(8 * scale) or 5
    
    local statFrame = Instance.new("Frame")
    statFrame.Name = statName .. "Frame"
    statFrame.Size = UDim2.new(1, 0, 0, statFrameHeight)
    statFrame.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
    statFrame.BorderSizePixel = 0
    statFrame.Parent = contentFrame
    
    local statCorner = Instance.new("UICorner")
    statCorner.CornerRadius = UDim.new(0, isMobile and math.floor(10 * scale) or 6)
    statCorner.Parent = statFrame
    
    local statNameLabel = Instance.new("TextLabel")
    statNameLabel.Name = "StatName"
    statNameLabel.Size = UDim2.new(0.5, -statPadding, 1, -statInnerPadding*2)
    statNameLabel.Position = UDim2.new(0, statPadding, 0, statInnerPadding)
    statNameLabel.BackgroundTransparency = 1
    statNameLabel.Text = statName .. ":"
    statNameLabel.TextColor3 = Color3.fromRGB(200, 200, 200)
    statNameLabel.TextSize = isMobile and math.floor(20 * scale) or 18
    statNameLabel.Font = Enum.Font.Gotham
    statNameLabel.TextXAlignment = Enum.TextXAlignment.Left
    statNameLabel.TextScaled = isMobile
    statNameLabel.Parent = statFrame
    
    local statValueLabel = Instance.new("TextLabel")
    statValueLabel.Name = "StatValue"
    statValueLabel.Size = UDim2.new(0.5, -statPadding, 1, -statInnerPadding*2)
    statValueLabel.Position = UDim2.new(0.5, 0, 0, statInnerPadding)
    statValueLabel.BackgroundTransparency = 1
    statValueLabel.Text = tostring(value)
    statValueLabel.TextColor3 = Color3.fromRGB(100, 200, 255)
    statValueLabel.TextSize = isMobile and math.floor(20 * scale) or 18
    statValueLabel.Font = Enum.Font.GothamBold
    statValueLabel.TextXAlignment = Enum.TextXAlignment.Right
    statValueLabel.TextScaled = isMobile
    statValueLabel.Parent = statFrame
    
    return statValueLabel
end

local statObjects = {}

local function findStatObject(statName)
    if statObjects[statName] then
        return statObjects[statName]
    end
    
    local variations = {statName, statName:lower(), statName:upper(), statName:sub(1,1):upper()..statName:sub(2):lower()}
    
    for _, name in pairs(variations) do
        local found = player:FindFirstChild(name)
        if found and (found:IsA("IntValue") or found:IsA("NumberValue") or found:IsA("StringValue")) then
            statObjects[statName] = found
            return found
        end
    end
    
    if instances then
        for _, instance in pairs(instances) do
            if instance.Parent == player then
                local instanceName = instance.Name:lower()
                for _, name in pairs(variations) do
                    if instanceName == name:lower() and (instance:IsA("IntValue") or instance:IsA("NumberValue") or instance:IsA("StringValue")) then
                        statObjects[statName] = instance
                        return instance
                    end
                end
            end
        end
    end
    
    return nil
end

local function getPlayerStats()
    local stats = {
        Coins = 0,
        Gems = 0,
        Triumphs = 0,
        Loses = 0,
        Level = 0
    }
    
    local coins = findStatObject("Coins") or findStatObject("coins")
    local gems = findStatObject("Gems")
    local triumphs = findStatObject("Triumphs") or findStatObject("triumps")
    local loses = findStatObject("Loses") or findStatObject("loses")
    local level = findStatObject("Level")
    
    if coins then stats.Coins = coins.Value end
    if gems then stats.Gems = gems.Value end
    if triumphs then stats.Triumphs = triumphs.Value end
    if loses then stats.Loses = loses.Value end
    if level then stats.Level = level.Value end
    
    return stats
end

local stats = getPlayerStats()
local statLabels = {}

statLabels.Coins = createStatLabel("Coins", stats.Coins)
statLabels.Gems = createStatLabel("Gems", stats.Gems)
statLabels.Triumphs = createStatLabel("Triumphs", stats.Triumphs)
statLabels.Loses = createStatLabel("Loses", stats.Loses)
statLabels.Level = createStatLabel("Level", stats.Level)

local canvasPadding = math.floor(20 * scale * mobileScale)
contentFrame.CanvasSize = UDim2.new(0, 0, 0, listLayout.AbsoluteContentSize.Y + canvasPadding)

listLayout:GetPropertyChangedSignal("AbsoluteContentSize"):Connect(function()
    contentFrame.CanvasSize = UDim2.new(0, 0, 0, listLayout.AbsoluteContentSize.Y + canvasPadding)
end)

local function updateStats()
    local newStats = getPlayerStats()
    if statLabels.Coins then statLabels.Coins.Text = tostring(newStats.Coins) end
    if statLabels.Gems then statLabels.Gems.Text = tostring(newStats.Gems) end
    if statLabels.Triumphs then statLabels.Triumphs.Text = tostring(newStats.Triumphs) end
    if statLabels.Loses then statLabels.Loses.Text = tostring(newStats.Loses) end
    if statLabels.Level then statLabels.Level.Text = tostring(newStats.Level) end
end

local function setupStatMonitoring(statObj)
    if not statObj then return end
    
    if _G.getconnections then
        local success, connections = pcall(function() return _G.getconnections(statObj.Changed) end)
        if success and connections and #connections > 0 then
            for _, connection in pairs(connections) do
                if connection.State then
                    connection:Enable()
                end
            end
        end
    end
    
    statObj.Changed:Connect(function()
        updateStats()
    end)
end

local function refreshStatObjects()
    statObjects = {}
    findStatObject("Coins")
    findStatObject("Gems")
    findStatObject("Triumphs")
    findStatObject("Loses")
    findStatObject("Level")
    
    for statName, statObj in pairs(statObjects) do
        if statObj and statObj.Parent == player then
            setupStatMonitoring(statObj)
        end
    end
end

for _, stat in pairs(player:GetChildren()) do
    local statName = stat.Name:lower()
    if (statName == "coins" or statName == "gems" or statName == "triumphs" or statName == "triumps" or 
        statName == "loses" or statName == "level") and 
        (stat:IsA("IntValue") or stat:IsA("NumberValue") or stat:IsA("StringValue")) then
        setupStatMonitoring(stat)
    end
end

player.ChildAdded:Connect(function(child)
    local statName = child.Name:lower()
    if (statName == "coins" or statName == "gems" or statName == "triumphs" or statName == "triumps" or 
        statName == "loses" or statName == "level") and 
        (child:IsA("IntValue") or child:IsA("NumberValue") or child:IsA("StringValue")) then
        setupStatMonitoring(child)
        refreshStatObjects()
    end
end)

refreshStatObjects()

spawn(function()
    while wait(1) do
        updateStats()
    end
end)

spawn(function()
    while wait(5) do
        refreshStatObjects()
    end
end)

